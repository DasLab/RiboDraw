<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of draw_helix</title>
  <meta name="keywords" content="draw_helix">
  <meta name="description" content="helix = draw_helix( helix )">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html helix -->
<h1>draw_helix
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>helix = draw_helix( helix )</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function helix = draw_helix( helix ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> helix = draw_helix( helix )

 This is the *master drawing function* of RiboDraw.

 It draws a 'helix' which is composed of a stem of Watson-Crick
  paired residues, as well as loop residues that are nearby and 
  translate, reflect, or rotate with the helix.

 The function also updates any linkers, selections (domains), helix labels,
  and ticks associated with these residues.

 The name 'helix' is probably a misnomer, but grew historically out of the
  very first scratch code for RiboDraw.

 TODO: Update to handle non-helical RNA structures like G-quadruplexes.

 INPUT:
   helix = helix object, or tag of helix object in current drawing (gca)

 OUTPUT:
   helix = updated helix object

 (C) R. Das, Stanford University, 2017-2018</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="draw_helix.html" class="code" title="function helix = draw_helix( helix )">draw_helix</a>	helix = draw_helix( helix )</li><li><a href="get_helix_rotation_matrix.html" class="code" title="function R = get_helix_rotation_matrix( helix )">get_helix_rotation_matrix</a>	R = get_helix_rotation_matrix( helix )</li><li><a href="redraw_helix.html" class="code" title="function redraw_helix( h )">redraw_helix</a>	redraw_helix( h )</li><li><a href="redraw_res_and_helix.html" class="code" title="function redraw_res_and_helix( h )">redraw_res_and_helix</a>	redraw_res_and_helix( h )</li><li><a href="reflect_helix.html" class="code" title="function reflect_helix( h, ~, ~ )">reflect_helix</a>	reflect_helix( h, ~, ~ )</li><li><a href="rotate_helix.html" class="code" title="function rotate_helix( h, ~, ~ )">rotate_helix</a>	rotate_helix( h, ~, ~ )</li><li><a href="set_helix_visibility.html" class="code" title="function set_helix_visibility( helix, visible )">set_helix_visibility</a>	set_helix_visibility( helix, visible )</li><li><a href="set_text_alignment.html" class="code" title="function set_text_alignment( h, v )">set_text_alignment</a>	set_text_alignment( h, v )</li><li><a href="update_tick.html" class="code" title="function update_tick( residue, plot_settings, R )">update_tick</a>	update_tick( residue, plot_settings, R )</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="convert_problem_helices_to_domains.html" class="code" title="function convert_problem_helices_to_domains()">convert_problem_helices_to_domains</a>	convert_problem_helices_to_domains()</li><li><a href="draw_helices.html" class="code" title="function draw_helices( helices )">draw_helices</a>	draw_helices( helices )</li><li><a href="draw_helix.html" class="code" title="function helix = draw_helix( helix )">draw_helix</a>	helix = draw_helix( helix )</li><li><a href="redraw_helices.html" class="code" title="function redraw_helices()">redraw_helices</a>	redraw_helices()</li><li><a href="redraw_helix.html" class="code" title="function redraw_helix( h )">redraw_helix</a>	redraw_helix( h )</li><li><a href="redraw_residues.html" class="code" title="function redraw_residues( residues )">redraw_residues</a>	redraw_residues( residues )</li><li><a href="reflect_helix.html" class="code" title="function reflect_helix( h, ~, ~ )">reflect_helix</a>	reflect_helix( h, ~, ~ )</li><li><a href="rotate_helix.html" class="code" title="function rotate_helix( h, ~, ~ )">rotate_helix</a>	rotate_helix( h, ~, ~ )</li><li><a href="update_residue_after_helix_reassignment.html" class="code" title="function update_residue_after_helix_reassignment( residue )">update_residue_after_helix_reassignment</a>	update_residue_after_helix_reassignment( residue )</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function h = draw_residue_for_helix( res_tag, helix_center, R, plot_settings );</a></li><li><a href="#_sub2" class="code">function relpos = set_default_relpos( residue, helix, plot_settings )</a></li><li><a href="#_sub3" class="code">function pos = update_residue_pos( res_tag, relpos, center, R );</a></li><li><a href="#_sub4" class="code">function helix = make_helix_label( helix, plot_settings, R )</a></li><li><a href="#_sub5" class="code">function move_helix_label(h)</a></li><li><a href="#_sub6" class="code">function redraw_helix_label(h)</a></li><li><a href="#_sub7" class="code">function residue = draw_tick( residue, plot_settings, R )</a></li><li><a href="#_sub8" class="code">function residue = set_default_tickrot( residue )</a></li><li><a href="#_sub9" class="code">function move_tick(h)</a></li><li><a href="#_sub10" class="code">function redraw_tick_res_and_helix(h)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function helix = draw_helix( helix )</a>
0002 <span class="comment">% helix = draw_helix( helix )</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% This is the *master drawing function* of RiboDraw.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% It draws a 'helix' which is composed of a stem of Watson-Crick</span>
0007 <span class="comment">%  paired residues, as well as loop residues that are nearby and</span>
0008 <span class="comment">%  translate, reflect, or rotate with the helix.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% The function also updates any linkers, selections (domains), helix labels,</span>
0011 <span class="comment">%  and ticks associated with these residues.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% The name 'helix' is probably a misnomer, but grew historically out of the</span>
0014 <span class="comment">%  very first scratch code for RiboDraw.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% TODO: Update to handle non-helical RNA structures like G-quadruplexes.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% INPUT:</span>
0019 <span class="comment">%   helix = helix object, or tag of helix object in current drawing (gca)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% OUTPUT:</span>
0022 <span class="comment">%   helix = updated helix object</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% (C) R. Das, Stanford University, 2017-2018</span>
0025 
0026 <span class="keyword">if</span> ischar( helix ); helix = getappdata(gca,helix); <span class="keyword">end</span>;
0027     
0028 plot_settings = getappdata( gca, <span class="string">'plot_settings'</span> );
0029 
0030 helix_center = helix.center;
0031 R = <a href="get_helix_rotation_matrix.html" class="code" title="function R = get_helix_rotation_matrix( helix )">get_helix_rotation_matrix</a>( helix ); 
0032 N = length( helix.resnum1 );
0033 spacing = plot_settings.spacing;
0034 bp_spacing = plot_settings.bp_spacing;
0035 helix_res_tags = {};
0036 <span class="keyword">for</span> k = 1:N
0037     <span class="comment">% first partner of base pair -- will draw below.</span>
0038     res_tag = sprintf( <span class="string">'Residue_%s%s%d'</span>, helix.chain1(k), helix.segid1{k}, helix.resnum1(k) );
0039     pos1 = <a href="#_sub3" class="code" title="subfunction pos = update_residue_pos( res_tag, relpos, center, R );">update_residue_pos</a>( res_tag, [ spacing*((k-1)-(N-1)/2), -bp_spacing/2], helix.center, R );
0040     helix_res_tags = [helix_res_tags, res_tag ];
0041     
0042     <span class="comment">% second partner of base pair -- will draw below.</span>
0043     res_tag = sprintf( <span class="string">'Residue_%s%s%d'</span>, helix.chain2(N-k+1), helix.segid1{N-k+1}, helix.resnum2(N-k+1) );
0044     pos2 = <a href="#_sub3" class="code" title="subfunction pos = update_residue_pos( res_tag, relpos, center, R );">update_residue_pos</a>( res_tag, [ spacing*((k-1)-(N-1)/2), +bp_spacing/2], helix.center, R );
0045     helix_res_tags = [helix_res_tags, res_tag ];
0046     
0047     all_pos1(k,:) = pos1;
0048     all_pos2(k,:) = pos2;
0049 <span class="keyword">end</span>
0050 
0051 <span class="comment">% draw all residues that are associated with the helix</span>
0052 not_helix_res_tags = {};
0053 <span class="keyword">for</span> i = 1:length( helix.associated_residues )
0054     res_tag = helix.associated_residues{i};
0055     residue = getappdata( gca, res_tag );
0056     <span class="keyword">if</span> ~isfield( residue, <span class="string">'name'</span> ) <span class="keyword">continue</span>; <span class="keyword">end</span>;
0057     <span class="keyword">if</span> ~isfield( residue, <span class="string">'relpos'</span> ) 
0058         residue.relpos = <a href="#_sub2" class="code" title="subfunction relpos = set_default_relpos( residue, helix, plot_settings )">set_default_relpos</a>( residue, helix, plot_settings ); 
0059         setappdata( gca, res_tag, residue );
0060     <span class="keyword">end</span>;
0061     <a href="#_sub1" class="code" title="subfunction h = draw_residue_for_helix( res_tag, helix_center, R, plot_settings );">draw_residue_for_helix</a>( res_tag, helix_center, R, plot_settings );
0062     <span class="keyword">if</span> ~any(strcmp(  helix_res_tags, res_tag )) not_helix_res_tags = [not_helix_res_tags, res_tag]; <span class="keyword">end</span>;
0063 <span class="keyword">end</span>
0064 
0065 <span class="comment">% update any linkers associated with these residues</span>
0066 <span class="comment">% in the future, these could include base pairs (incl. non-canonicals)</span>
0067 redrawn_linkers = {};
0068 <span class="keyword">for</span> i = 1:length( helix.associated_residues )
0069     res_tag = helix.associated_residues{i};
0070     residue = getappdata( gca, res_tag );
0071     <span class="keyword">if</span> ~isfield( residue, <span class="string">'linkers'</span> ) <span class="keyword">continue</span>; <span class="keyword">end</span>;
0072     linker_tags = residue.linkers;
0073     <span class="comment">% silly cleanup</span>
0074     <span class="keyword">for</span> k = 1 : length( linker_tags )
0075         <span class="keyword">if</span> any( strcmp( redrawn_linkers, linker_tags{k} ) ); <span class="keyword">continue</span>; <span class="keyword">end</span>; <span class="comment">% don't double-render, to save time.</span>
0076         linker = getappdata( gca, linker_tags{k} );
0077         draw_linker( linker, plot_settings );
0078         redrawn_linkers = [ redrawn_linkers, linker.linker_tag ];
0079     <span class="keyword">end</span>
0080 <span class="keyword">end</span>
0081 
0082 <span class="keyword">if</span> ~isfield( helix, <span class="string">'label_relpos'</span> ) helix.label_relpos = plot_settings.bp_spacing *[0 1]; <span class="keyword">end</span>;
0083 helix = <a href="#_sub4" class="code" title="subfunction helix = make_helix_label( helix, plot_settings, R )">make_helix_label</a>( helix, plot_settings, R );
0084 
0085 <span class="comment">% Selections (if they exist)</span>
0086 selections = {};
0087 motifs = {};
0088 <span class="keyword">for</span> i = 1:length( helix.associated_residues )
0089     res_tag = helix.associated_residues{i};
0090     residue = getappdata( gca, res_tag );
0091     <span class="keyword">if</span> isfield( residue, <span class="string">'associated_selections'</span> ) &amp; length( residue.associated_selections ) &gt; 0
0092         selections = [ selections, residue.associated_selections ];
0093     <span class="keyword">end</span>    
0094     <span class="keyword">if</span> isfield( residue, <span class="string">'associated_motifs'</span> ) &amp; length( residue.associated_motifs ) &gt; 0
0095         motifs = [ motifs, residue.associated_motifs ];
0096     <span class="keyword">end</span>    
0097 <span class="keyword">end</span>
0098 selections = unique( selections );
0099 draw_selections( selections );
0100 motifs = unique( motifs );
0101 draw_motifs( motifs );
0102 
0103 <span class="comment">% handles for helix editing</span>
0104 <span class="comment">% rectangle for dragging.</span>
0105 minpos = min( [all_pos1; all_pos2 ] );
0106 maxpos = max( [all_pos1; all_pos2 ] );
0107 helix = create_default_rectangle( helix, <span class="string">'helix_tag'</span>, helix.helix_tag, @<a href="redraw_helix.html" class="code" title="function redraw_helix( h )">redraw_helix</a> );
0108 set_rectangle_coords( helix, minpos, maxpos, spacing );
0109 
0110 <span class="comment">% for helix: clickable line of reflection</span>
0111 <span class="keyword">if</span> ~isfield( helix, <span class="string">'reflect_line1'</span> )
0112     h = plot( [0 0], [0 0], <span class="string">'color'</span>,[0.5 0.5 1],<span class="string">'clipping'</span>,<span class="string">'off'</span> );
0113     setappdata( h, <span class="string">'helix_tag'</span>, helix.helix_tag);
0114     set(h,<span class="string">'ButtonDownFcn'</span>,{@<a href="reflect_helix.html" class="code" title="function reflect_helix( h, ~, ~ )">reflect_helix</a>,h});
0115     helix.reflect_line1 = h;
0116 <span class="keyword">end</span>
0117 line1 = helix_center + spacing*[-(N+0.25)/2, 0]*R;
0118 line1x = helix_center + spacing*[-(N-0.75)/2, 0]*R;
0119 set( helix.reflect_line1, <span class="string">'Xdata'</span>, [line1(1) line1x(1)], <span class="string">'Ydata'</span>, [line1(2) line1x(2)]);
0120 
0121 <span class="keyword">if</span> ~isfield( helix, <span class="string">'reflect_line2'</span> )
0122     h = plot( [0 0], [0 0], <span class="string">'color'</span>,[0.5 0.5 1],<span class="string">'clipping'</span>,<span class="string">'off'</span> );
0123     setappdata( h, <span class="string">'helix_tag'</span>, helix.helix_tag);
0124     set(h,<span class="string">'ButtonDownFcn'</span>,{@<a href="reflect_helix.html" class="code" title="function reflect_helix( h, ~, ~ )">reflect_helix</a>,h});
0125     helix.reflect_line2 = h;
0126 <span class="keyword">end</span>
0127 line2 = helix_center + spacing*[ (N+0.25)/2, 0]*R;
0128 line2x = helix_center + spacing*[ (N-0.75)/2, 0]*R;
0129 set( helix.reflect_line2, <span class="string">'Xdata'</span>, [line2(1) line2x(1)], <span class="string">'Ydata'</span>, [line2(2) line2x(2)]);
0130 
0131 <span class="comment">% for helix: clickable center of rotation</span>
0132 <span class="keyword">if</span> ~isfield( helix, <span class="string">'click_center'</span> )
0133     h = rectangle( <span class="string">'Position'</span>,<span class="keyword">...</span>
0134         [ 0 0 0 0 ], <span class="keyword">...</span>
0135         <span class="string">'curvature'</span>,[0.5 0.5],<span class="keyword">...</span>
0136         <span class="string">'edgecolor'</span>,[0.5 0.5 1],<span class="keyword">...</span>
0137         <span class="string">'facecolor'</span>,[0.5 0.5 1],<span class="string">'linewidth'</span>,1.5,<span class="string">'clipping'</span>,<span class="string">'off'</span> );
0138     setappdata( h,<span class="string">'helix_tag'</span>, helix.helix_tag);
0139     set(h,<span class="string">'ButtonDownFcn'</span>,{@<a href="rotate_helix.html" class="code" title="function rotate_helix( h, ~, ~ )">rotate_helix</a>,h});
0140     helix.click_center = h;
0141 <span class="keyword">end</span>
0142 set( helix.click_center, <span class="string">'Position'</span>, [helix_center(1)-0.15*spacing helix_center(2)-0.15*spacing,<span class="keyword">...</span>
0143     0.3*spacing 0.3*spacing]);
0144 
0145 <a href="set_helix_visibility.html" class="code" title="function set_helix_visibility( helix, visible )">set_helix_visibility</a>( helix, plot_settings.show_helix_controls );
0146 
0147 <span class="comment">% make ticklabels draggable</span>
0148 <span class="keyword">for</span> i = 1:length( helix.associated_residues )
0149     res_tag = helix.associated_residues{i};
0150     residue = getappdata( gca, res_tag );
0151     <span class="keyword">if</span> isfield( residue, <span class="string">'tick_label'</span> ) &amp; isvalid( residue.tick_label )
0152         setappdata( residue.tick_label, <span class="string">'res_tag'</span>, res_tag );
0153         <span class="keyword">if</span> ~isappdata(residue.tick_label,<span class="string">'user_movefcn'</span>); draggable( residue.tick_label, @<a href="#_sub9" class="code" title="subfunction move_tick(h)">move_tick</a>, <span class="string">'endfcn'</span>, @<a href="#_sub10" class="code" title="subfunction redraw_tick_res_and_helix(h)">redraw_tick_res_and_helix</a> ); <span class="keyword">end</span>;
0154     <span class="keyword">end</span>
0155 <span class="keyword">end</span>
0156 
0157 <span class="comment">% make single-stranded residues draggable...</span>
0158 <span class="keyword">for</span> i = 1:length( not_helix_res_tags )
0159     res_tag = not_helix_res_tags{i};
0160     residue = getappdata( gca, res_tag );
0161     <span class="keyword">if</span> ~isappdata(residue.handle,<span class="string">'user_movefcn'</span>); draggable( residue.handle,<span class="string">'n'</span>,[-inf inf -inf inf],@move_snapgrid, <span class="string">'endfcn'</span>, @<a href="redraw_res_and_helix.html" class="code" title="function redraw_res_and_helix( h )">redraw_res_and_helix</a> ); <span class="keyword">end</span>;
0162 <span class="keyword">end</span>
0163 
0164 draw_base_rope();
0165 
0166 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0167 <span class="comment">% DO THIS AT THE END</span>
0168 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0169 <span class="comment">% 'global data' (stored in figure)</span>
0170 setappdata( gca, helix.helix_tag, helix );
0171 
0172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0173 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0174 <span class="comment">% Helper functions</span>
0175 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0176 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0177 
0178 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0179 <span class="comment">% Residue</span>
0180 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0181 <a name="_sub1" href="#_subfunctions" class="code">function h = draw_residue_for_helix( res_tag, helix_center, R, plot_settings );</a>
0182 residue = getappdata( gca, res_tag );
0183 <span class="keyword">if</span> isfield( residue, <span class="string">'relpos'</span> ) 
0184     pos = helix_center +  residue.relpos * R ;
0185     residue.plot_pos = pos;
0186     residue.res_tag = res_tag;
0187 
0188     residue = draw_residue( residue );
0189     h = residue.handle;
0190 
0191     set( h, <span class="string">'Position'</span>, pos );
0192     setappdata( residue.handle, <span class="string">'res_tag'</span>, res_tag );
0193     residue = <a href="#_sub7" class="code" title="subfunction residue = draw_tick( residue, plot_settings, R )">draw_tick</a>( residue, plot_settings, R );
0194     setappdata( gca, res_tag, residue );
0195 <span class="keyword">end</span>
0196 
0197 
0198 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0199 <a name="_sub2" href="#_subfunctions" class="code">function relpos = set_default_relpos( residue, helix, plot_settings )</a>
0200 <span class="comment">% need to find which helix st;rand to append to, and then go out a bit.</span>
0201 dist1 = min( abs(helix.resnum1 - residue.resnum) );
0202 <span class="keyword">if</span> ( residue.chain ~= helix.chain1(1) ) dist1 = Inf * dist1; <span class="keyword">end</span>;
0203 dist2 = min( abs(helix.resnum2 - residue.resnum) );
0204 <span class="keyword">if</span> ( residue.chain ~= helix.chain2(1) ) dist2 = Inf * dist2; <span class="keyword">end</span>;
0205 [~,strand] = min( [min( dist1 ), min( dist2 )] );
0206 N = length( helix.resnum1 );
0207 <span class="keyword">if</span> ( strand == 1 )   
0208     d = residue.resnum-helix.resnum1(1);
0209     <span class="keyword">if</span> abs(d) &gt; 10; d = sign(d) * 10 * ( log( abs(d)/ 10) + 1 );  <span class="keyword">end</span>;
0210     relpos = [ plot_settings.spacing*(d-(N-1)/2), -plot_settings.bp_spacing/2];
0211 <span class="keyword">else</span>
0212     assert( strand == 2 );    
0213     d = residue.resnum-helix.resnum2(1);
0214     <span class="keyword">if</span> abs(d) &gt; 10; d = sign(d) * 10 * ( log( abs(d)/ 10) + 1 );  <span class="keyword">end</span>;
0215     relpos = [ plot_settings.spacing*(-d+(N-1)/2), +plot_settings.bp_spacing/2];  
0216 <span class="keyword">end</span>
0217 
0218 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0219 <a name="_sub3" href="#_subfunctions" class="code">function pos = update_residue_pos( res_tag, relpos, center, R );</a>
0220 residue = getappdata( gca, res_tag );
0221 residue.relpos = relpos;
0222 pos = center + relpos*R;
0223 setappdata( gca, res_tag, residue);
0224         
0225 
0226 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0227 <span class="comment">% Helix label</span>
0228 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0229 <a name="_sub4" href="#_subfunctions" class="code">function helix = make_helix_label( helix, plot_settings, R )</a>
0230 <span class="comment">% make label</span>
0231 <span class="keyword">if</span> ~isfield( helix, <span class="string">'label'</span> ) | ~isvalid( helix.label)
0232     h = text( 0,0, helix.name,<span class="keyword">...</span>
0233         <span class="string">'fontsize'</span>, plot_settings.fontsize*1.5, <span class="string">'fontname'</span>,<span class="string">'helvetica'</span>,<span class="string">'clipping'</span>,<span class="string">'off'</span>);
0234     helix.label = h;
0235     <span class="comment">% draggable helix label</span>
0236     setappdata( helix.label, <span class="string">'helix_tag'</span>, helix.helix_tag );
0237     draggable( helix.label, <span class="string">'n'</span>,[-inf inf -inf inf], @<a href="#_sub5" class="code" title="subfunction move_helix_label(h)">move_helix_label</a>, <span class="string">'endfcn'</span>, @<a href="#_sub6" class="code" title="subfunction redraw_helix_label(h)">redraw_helix_label</a> )
0238 <span class="keyword">end</span>
0239 h = helix.label;
0240 label_pos = helix.center + helix.label_relpos * R;
0241 set( h, <span class="string">'String'</span>, helix.name );
0242 set( h, <span class="string">'position'</span>, label_pos );
0243 set( h, <span class="string">'fontsize'</span>, plot_settings.fontsize*1.5 );
0244 
0245 color = <span class="string">'k'</span>;
0246 <span class="keyword">if</span> isfield( plot_settings, <span class="string">'line_color'</span> ); color = plot_settings.line_color; <span class="keyword">end</span>;
0247 <span class="keyword">if</span> isfield( helix, <span class="string">'rgb_color'</span> ) color = helix.rgb_color; <span class="keyword">end</span>;
0248 set( h, <span class="string">'color'</span>, color );
0249 
0250 v = [0,sign(helix.label_relpos(2))]*R;
0251 <a href="set_text_alignment.html" class="code" title="function set_text_alignment( h, v )">set_text_alignment</a>( h, v );
0252 <span class="keyword">if</span> isfield( helix, <span class="string">'label_visible'</span> )
0253     <span class="keyword">if</span> helix.label_visible; visible = <span class="string">'on'</span>; <span class="keyword">else</span>; visible = <span class="string">'off'</span>; <span class="keyword">end</span>;
0254     set( helix.label, <span class="string">'visible'</span>, visible );
0255 <span class="keyword">end</span>
0256 
0257 
0258 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0259 <a name="_sub5" href="#_subfunctions" class="code">function move_helix_label(h)</a>
0260 pos = get(h,<span class="string">'position'</span>); 
0261 helix_tag = getappdata( h, <span class="string">'helix_tag'</span> );
0262 helix = getappdata( gca, helix_tag );
0263 R = <a href="get_helix_rotation_matrix.html" class="code" title="function R = get_helix_rotation_matrix( helix )">get_helix_rotation_matrix</a>( helix );
0264 relpos = (pos(1:2) - helix.center)*R';
0265 v = [0,sign(relpos(2))]*R;
0266 <a href="set_text_alignment.html" class="code" title="function set_text_alignment( h, v )">set_text_alignment</a>( h, v );
0267 
0268 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0269 <a name="_sub6" href="#_subfunctions" class="code">function redraw_helix_label(h)</a>
0270 
0271 pos = get(h,<span class="string">'position'</span>); 
0272 helix_tag = getappdata( h, <span class="string">'helix_tag'</span> );
0273 helix = getappdata( gca, helix_tag );
0274 
0275 <span class="comment">% need to figure out rel_pos back in the 'frame' of the helix.</span>
0276 <span class="comment">% for that I need to figure out rotation matrix.</span>
0277 R = <a href="get_helix_rotation_matrix.html" class="code" title="function R = get_helix_rotation_matrix( helix )">get_helix_rotation_matrix</a>( helix );
0278 helix.label_relpos = ( pos(1:2) - helix.center ) * R';
0279 
0280 <span class="comment">% snap to grid?</span>
0281 plot_settings = getappdata( gca, <span class="string">'plot_settings'</span> );
0282 snap_spacing = plot_settings.bp_spacing/4;
0283 helix.label_relpos = round( helix.label_relpos / snap_spacing ) * snap_spacing;
0284 
0285 <a href="draw_helix.html" class="code" title="function helix = draw_helix( helix )">draw_helix</a>( helix );
0286 
0287 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0288 <span class="comment">% Ticks</span>
0289 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0290 <a name="_sub7" href="#_subfunctions" class="code">function residue = draw_tick( residue, plot_settings, R )</a>
0291 
0292 <span class="keyword">if</span> ( mod(residue.resnum,10) ~= 0 ); <span class="keyword">return</span>; <span class="keyword">end</span>;
0293 <span class="keyword">if</span> isfield(residue,<span class="string">'ligand_partners'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>;
0294 
0295 <span class="keyword">if</span> ~isfield( residue, <span class="string">'tickrot'</span> ) residue.tickrot = nan; <span class="keyword">end</span>; <span class="comment">% nan means set later based on how helix is rotated.</span>
0296 
0297 color = <span class="string">'k'</span>;
0298 <span class="keyword">if</span> isfield( plot_settings, <span class="string">'line_color'</span> ); color = plot_settings.line_color; <span class="keyword">end</span>;
0299 
0300 <span class="keyword">if</span> ~isfield( residue, <span class="string">'tick_handle'</span> ) | ~isvalid( residue.tick_handle )
0301     residue.tick_handle = plot( [0,0],[0,0],color,<span class="string">'linewidth'</span>,0.5,<span class="string">'clipping'</span>,<span class="string">'off'</span>); <span class="comment">% dummy for now -- will get redrawn later.</span>
0302     setappdata( gca, residue.res_tag, residue );
0303 <span class="keyword">end</span>
0304 
0305 <span class="keyword">if</span> ~isfield( residue, <span class="string">'tick_label'</span> ) | ~isvalid( residue.tick_label )
0306     residue.tick_label = text( 0, 0, num2str(residue.resnum), <span class="string">'fontsize'</span>, plot_settings.fontsize,<span class="keyword">...</span>
0307         <span class="string">'horizontalalign'</span>,<span class="string">'center'</span>,<span class="string">'verticalalign'</span>,<span class="string">'middle'</span>,<span class="string">'clipping'</span>,<span class="string">'off'</span>,<span class="string">'color'</span>,color );
0308     setappdata( gca, residue.res_tag, residue );
0309 <span class="keyword">end</span>
0310 
0311 <span class="keyword">if</span> isfield( residue, <span class="string">'tickrot'</span> ) 
0312     <span class="keyword">if</span>  isnan(residue.tickrot) residue = <a href="#_sub8" class="code" title="subfunction residue = set_default_tickrot( residue )">set_default_tickrot</a>( residue ); <span class="keyword">end</span>;
0313     <a href="update_tick.html" class="code" title="function update_tick( residue, plot_settings, R )">update_tick</a>( residue, plot_settings, R );
0314 <span class="keyword">end</span>
0315 
0316 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0317 <a name="_sub8" href="#_subfunctions" class="code">function residue = set_default_tickrot( residue )</a>
0318 <span class="keyword">if</span> ( sign( residue.relpos(2) ) &gt; 0 ) 
0319     residue.tickrot = 90;
0320 <span class="keyword">else</span>
0321     residue.tickrot = 270;
0322 <span class="keyword">end</span>
0323 
0324 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0325 <a name="_sub9" href="#_subfunctions" class="code">function move_tick(h)</a>
0326 <span class="comment">% snap to grid during movement.</span>
0327 pos = get(h,<span class="string">'Position'</span>);
0328 pos = pos(1:2); <span class="comment">% text</span>
0329 residue = getappdata( gca, getappdata(h,<span class="string">'res_tag'</span>) );
0330 v = pos - residue.plot_pos;
0331 theta = atan2( v(2), v(1) );
0332 theta = round(theta*180/pi/45)*45;
0333 v = [cos(theta*pi/180),sin(theta*pi/180)];
0334 plot_settings = getappdata(gca,<span class="string">'plot_settings'</span>);
0335 labelpos = residue.plot_pos + v*plot_settings.bp_spacing*2/3;
0336 set(h,<span class="string">'Position'</span>,labelpos);
0337 <a href="set_text_alignment.html" class="code" title="function set_text_alignment( h, v )">set_text_alignment</a>( h, v );
0338 
0339 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0340 <a name="_sub10" href="#_subfunctions" class="code">function redraw_tick_res_and_helix(h)</a>
0341 
0342 pos = get(h,<span class="string">'Position'</span>);
0343 pos = pos(1:2); <span class="comment">% text</span>
0344 
0345 <span class="comment">% position relative to residue will define tickrot</span>
0346 res_tag =  getappdata(h,<span class="string">'res_tag'</span>);
0347 residue = getappdata( gca,res_tag );
0348 v = pos - residue.plot_pos;
0349 helix = getappdata( gca, residue.helix_tag );
0350 
0351 <span class="comment">% need to get into 'helix frame';</span>
0352 R = <a href="get_helix_rotation_matrix.html" class="code" title="function R = get_helix_rotation_matrix( helix )">get_helix_rotation_matrix</a>( helix );
0353 v = v*R'; 
0354 tickrot = mod( round(atan2(v(2),v(1))*180/pi/45)*45, 360 );
0355 residue.tickrot = tickrot;
0356 setappdata( gca, res_tag, residue );
0357 
0358 <span class="comment">% shortcut to redraw everything.</span>
0359 <a href="redraw_res_and_helix.html" class="code" title="function redraw_res_and_helix( h )">redraw_res_and_helix</a>( residue.handle );
0360</pre></div>
<hr><address>Generated on Thu 31-Oct-2019 15:46:50 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>